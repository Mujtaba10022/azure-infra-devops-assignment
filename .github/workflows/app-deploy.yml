name: Deploy to AKS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with: 
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get AKS Credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ secrets.AKS_RG }} \
          --name ${{ secrets.AKS_NAME }}
    
    - name: Create Kubernetes Secrets from GitHub Secrets
      run: |
        kubectl delete secret sql-agent-secrets --ignore-not-found
        kubectl create secret generic sql-agent-secrets \
          --from-literal=SQL_PASSWORD=${{ secrets.SQL_ADMIN_PASSWORD }} \
          --from-literal=AZURE_OPENAI_KEY=${{ secrets.AZURE_OPENAI_KEY }} \
          --from-literal=AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}
    
    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/sql-agent.yaml

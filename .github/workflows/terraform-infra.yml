name: 'Deploy Infrastructure and App'

on: 
  push: 
    branches: [ main ]
  workflow_dispatch:

permissions: 
  contents: read

jobs: 
  deploy:
    name:  'Deploy'
    runs-on: ubuntu-latest
    environment: staging

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name:  Check/Create AKS Cluster
      run: |
        if az aks show --name aks-gm-staging --resource-group RG-GM_Assessment &>/dev/null; then
          echo "AKS cluster already exists"
        else
          echo "Creating AKS cluster..."
          az aks create \
            --resource-group RG-GM_Assessment \
            --name aks-gm-staging \
            --node-count 1 \
            --node-vm-size Standard_B2s \
            --generate-ssh-keys \
            --enable-managed-identity \
            --tags Environment=staging Project=GM-Assessment
        fi

    - name: Get AKS Credentials
      run: |
        az aks get-credentials --resource-group RG-GM_Assessment --name aks-gm-staging --overwrite-existing

    - name: Deploy Application
      run: |
        kubectl apply -f k8s/webapp.yaml
        echo "Waiting for deployment..."
        kubectl rollout status deployment/webapp --timeout=120s

    - name: Get Application URL
      run: |
        echo "Waiting for LoadBalancer IP..."
        sleep 60
        kubectl get service webapp-service
        kubectl get pods

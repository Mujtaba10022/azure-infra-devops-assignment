name: Deploy SQL Agent

on: 
  push:
    branches: [main]
    paths:
      - 'k8s/**'
      - 'app/**'
      - '.github/workflows/deploy-sql-agent.yml'
  workflow_dispatch:

jobs:
  deploy: 
    runs-on: ubuntu-latest
    
    steps: 
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with: 
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials --resource-group RG-GM_Assessment --name aks-gm-staging --overwrite-existing

    - name: Create Kubernetes Secrets from GitHub Secrets
      run: |
        kubectl create secret generic sql-agent-secrets \
          --from-literal=SQL_PASSWORD=${{ secrets.SQL_ADMIN_PASSWORD }} \
          --from-literal=AZURE_OPENAI_KEY=${{ secrets.AZURE_OPENAI_KEY }} \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Apply ConfigMap and Deployment
      run: |
        kubectl apply -f k8s/sql-agent.yaml

    - name: Restart Deployment
      run: |
        kubectl rollout restart deployment/sql-agent
        kubectl rollout status deployment/sql-agent

    - name: Verify Deployment
      run: |
        kubectl get pods -l app=sql-agent
        kubectl get svc sql-agent-service
